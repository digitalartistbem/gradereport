<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bemmygail - Grading System</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #f3f4f6; 
            color: #1f2937;
        }

        /* Custom Scrollbar for Table */
        .table-container::-webkit-scrollbar { height: 12px; width: 12px; }
        .table-container::-webkit-scrollbar-track { background: #f1f5f9; }
        .table-container::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 6px; border: 3px solid #f1f5f9; }
        .table-container::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        /* Sticky Columns Logic */
        .sticky-left-1 { position: sticky; left: 0; z-index: 30; background-color: #fff; }
        .sticky-left-2 { position: sticky; left: 200px; z-index: 30; background-color: #fff; border-right: 2px solid #e2e8f0; }
        
        thead tr th { position: sticky; top: 0; z-index: 40; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        thead tr th.sticky-left-1 { z-index: 50; } 
        thead tr th.sticky-left-2 { z-index: 50; }

        /* Animations */
        .fade-in { animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Mode selector styles */
        .mode-btn { transition: all 0.3s ease; }
        .mode-btn.active { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.15); }

        /* =========================================
           PRINT STYLES - PRESERVE EXACT APPEARANCE
           ========================================= */
        @media print {
            @page { margin: 0.5cm; size: auto; }
            
            /* 1. Reset Page Dimensions */
            html, body {
                height: auto !important;
                min-height: 100% !important;
                overflow: visible !important;
                margin: 0 !important;
                padding: 0 !important;
            }

            /* 2. Hide Everything Except Modal */
            body > *:not(#modalContainer) {
                display: none !important;
            }

            /* 3. Force Modal to Flow Naturally */
            #modalContainer {
                display: block !important;
                position: relative !important;
                top: 0 !important;
                left: 0 !important;
                width: 100% !important;
                height: auto !important;
                min-height: 0 !important;
                max-height: none !important;
                overflow: visible !important;
                background: white !important;
                z-index: 9999;
                margin: 0 !important;
                padding: 0 !important;
            }

            /* 4. Unlock Inner Containers */
            #modalContainer .overflow-y-auto, 
            #modalContainer .max-h-\[95vh\] {
                overflow: visible !important;
                height: auto !important;
                max-height: none !important;
                display: block !important;
            }

            /* 5. Force Visibility */
            #modalContainer * {
                visibility: visible !important;
            }

            /* 6. PRESERVE ALL COLORS & STYLING - Don't override backgrounds! */
            /* Only remove excessive shadows for cleaner print */
            .shadow-2xl { 
                box-shadow: 0 2px 4px rgba(0,0,0,0.1) !important; 
            }
            
            /* 7. Hide UI Elements */
            .no-print, button:not(.print-keep), .close-btn, header { display: none !important; }

            /* 8. Show Charts */
            canvas {
                max-width: 100% !important;
                max-height: 250px !important;
                display: block !important;
            }

            /* 9. Prevent Awkward Breaks */
            tr { page-break-inside: avoid; }
            h1, h2, h3, h4, h5 { page-break-after: avoid; }
            .break-inside-avoid { page-break-inside: avoid; }
            
            /* Keep grid layouts together */
            .grid { page-break-inside: avoid; }
            
            /* 10. Make inputs visible with their values */
            input, textarea {
                border: 1px solid #e2e8f0 !important;
                background: white !important;
                padding: 0.5rem !important;
                font-size: 0.75rem !important;
                color: #000 !important;
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }

/* 11. Force Color Printing */
* {
    -webkit-print-color-adjust: exact !important; /* For WebKit-based browsers (e.g., Chrome, Safari) */
    print-color-adjust: exact !important; /* Standardized property */
}

            /* 12. Hide the separate print header, keep inline design */
            .hidden.print\\:block {
                display: none !important;
            }

            /* 13. Ensure modal content has proper padding */
            #modalContainer > div > div:last-child {
                padding: 2rem !important;
            }

            /* 14. Keep signature section at bottom */
            .invisible.print\\:visible {
                visibility: visible !important;
                margin-top: 3rem !important;
                page-break-before: avoid !important;
            }
        }
    </style>
</head>
<body class="flex flex-col min-h-screen">

    <header class="bg-slate-900 text-white shadow-lg sticky top-0 z-[60] no-print">
        <div class="max-w-full mx-auto px-6 py-4 flex justify-between items-center">
            <div class="flex items-center gap-4">
                <div class="bg-blue-600 p-2 rounded-lg text-white shadow-lg shadow-blue-500/50">
                    <i class="fas fa-university text-2xl"></i>
                </div>
                <div>
                    <h1 class="text-xl font-bold tracking-wide">BemmyGail Grading System</h1>
                    <p class="text-[10px] text-slate-400 uppercase tracking-wider font-semibold">LMS Grading & Reporting System</p>
                </div>
            </div>
            <button onclick="window.location.reload()" class="bg-slate-800 hover:bg-slate-700 text-slate-300 hover:text-white px-4 py-2 rounded-md text-sm transition shadow-sm border border-slate-700">
                <i class="fas fa-power-off mr-2"></i> Reset System
            </button>
        </div>
    </header>

    <main class="flex-grow p-6 no-print">
        
        <div id="errorBox" class="hidden max-w-4xl mx-auto mb-6 bg-red-50 border-l-4 border-red-500 text-red-700 p-4 rounded shadow-sm flex justify-between items-center fade-in">
            <div>
                <p class="font-bold"><i class="fas fa-exclamation-circle mr-2"></i> System Notice</p>
                <p class="text-sm" id="errorText">Error message here.</p>
            </div>
            <button onclick="document.getElementById('errorBox').classList.add('hidden')" class="text-red-700 font-bold hover:text-red-900">&times;</button>
        </div>

        <!-- Mode Selection Screen -->
        <div id="step-mode-select" class="max-w-4xl mx-auto bg-white rounded-xl shadow-xl p-12 text-center border border-slate-200 mt-10 fade-in relative overflow-hidden">
            <div class="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-blue-500 via-purple-500 to-pink-500"></div>
            
            <div class="w-24 h-24 bg-blue-50 rounded-full flex items-center justify-center mx-auto mb-6 shadow-inner">
                <i class="fas fa-graduation-cap text-blue-600 text-4xl"></i>
            </div>
            <h2 class="text-3xl font-bold text-slate-800 mb-3">Select Grading Mode</h2>
            <p class="text-slate-500 mb-10 text-lg">Choose the appropriate grading system for your students.</p>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 max-w-2xl mx-auto">
                <button onclick="selectMode('college')" class="mode-btn group bg-gradient-to-br from-blue-50 to-blue-100 hover:from-blue-100 hover:to-blue-200 border-2 border-blue-300 rounded-xl p-8 transition-all transform hover:-translate-y-1">
                    <div class="text-blue-600 text-5xl mb-4"><i class="fas fa-university"></i></div>
                    <h3 class="text-xl font-bold text-slate-800 mb-2">College Mode</h3>
                    <p class="text-sm text-slate-600 mb-4">4 Terms: Prelim, Midterm, Pre-Final, Finals</p>
                    <ul class="text-xs text-left text-slate-500 space-y-1">
                        <li><i class="fas fa-check text-blue-500 mr-2"></i>1.0 - 5.0 Grading Scale</li>
                        <li><i class="fas fa-check text-blue-500 mr-2"></i>LMS (40%) + F2F (60%)</li>
                        <li><i class="fas fa-check text-blue-500 mr-2"></i>Prelim/Midterm/PreFinal 20%, Finals 40%</li>
                    </ul>
                </button>

                <button onclick="selectMode('shs')" class="mode-btn group bg-gradient-to-br from-emerald-50 to-emerald-100 hover:from-emerald-100 hover:to-emerald-200 border-2 border-emerald-300 rounded-xl p-8 transition-all transform hover:-translate-y-1">
                    <div class="text-emerald-600 text-5xl mb-4"><i class="fas fa-school"></i></div>
                    <h3 class="text-xl font-bold text-slate-800 mb-2">Senior High School</h3>
                    <p class="text-sm text-slate-600 mb-4">2 Quarters per Semester</p>
                    <ul class="text-xs text-left text-slate-500 space-y-1">
                        <li><i class="fas fa-check text-emerald-500 mr-2"></i>1-100 Grading Scale</li>
                        <li><i class="fas fa-check text-emerald-500 mr-2"></i>Written Work 20%</li>
                        <li><i class="fas fa-check text-emerald-500 mr-2"></i>Performance Task 60%</li>
                        <li><i class="fas fa-check text-emerald-500 mr-2"></i>Quarterly Assessment 20%</li>
                    </ul>
                </button>
            </div>
        </div>

        <div id="step-upload" class="hidden max-w-3xl mx-auto bg-white rounded-xl shadow-xl p-12 text-center border border-slate-200 mt-10 fade-in relative overflow-hidden">
            <div class="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-blue-500 via-purple-500 to-pink-500"></div>
            
            <div class="w-24 h-24 bg-blue-50 rounded-full flex items-center justify-center mx-auto mb-6 shadow-inner">
                <i class="fas fa-file-csv text-blue-600 text-4xl"></i>
            </div>
            <h2 class="text-3xl font-bold text-slate-800 mb-3">Import Class Data</h2>
            <p class="text-slate-500 mb-4">Upload your Google Classroom CSV export to begin.</p>
            <p class="text-sm text-blue-600 font-semibold mb-8" id="modeIndicator"></p>
            
            <label class="cursor-pointer inline-block group">
                <input type="file" id="csvFile" accept=".csv" class="hidden" />
                <div class="bg-slate-900 group-hover:bg-blue-600 text-white font-semibold py-4 px-10 rounded-full shadow-xl transition-all transform group-hover:-translate-y-1 flex items-center gap-3 justify-center mx-auto w-fit">
                    <span id="btnUploadText">Select CSV File</span> <i class="fas fa-arrow-right"></i>
                </div>
            </label>
            <div id="loader" class="hidden mt-8 text-slate-400 text-sm font-semibold animate-pulse">
                <i class="fas fa-circle-notch fa-spin mr-2"></i> Processing Data...
            </div>
            <button onclick="backToModeSelect()" class="mt-6 text-slate-500 hover:text-slate-700 text-sm underline">
                <i class="fas fa-arrow-left mr-1"></i> Change Mode
            </button>
        </div>

        <div id="step-mapping" class="hidden max-w-[95%] mx-auto bg-white rounded-xl shadow-xl border border-slate-200 flex flex-col h-[82vh] fade-in">
            <div class="p-5 border-b bg-slate-50 flex justify-between items-center rounded-t-xl">
                <div>
                    <h2 class="font-bold text-xl text-slate-800">Map Activities</h2>
                    <p class="text-sm text-slate-500">Verify activity categories before generation.</p>
                </div>
                <button onclick="processGrades()" class="bg-emerald-600 hover:bg-emerald-700 text-white px-6 py-2.5 rounded-lg font-bold shadow-lg transition flex items-center gap-2 transform hover:scale-105">
                    Generate Dashboard <i class="fas fa-check-circle"></i>
                </button>
            </div>
            <div class="flex-grow overflow-auto p-0">
                <table class="w-full text-sm text-left border-collapse">
                    <thead class="bg-slate-100 text-xs uppercase text-slate-600 font-bold sticky top-0 z-10 shadow-sm">
                        <tr id="mappingHeader">
                            <!-- Dynamic headers based on mode -->
                        </tr>
                    </thead>
                    <tbody id="mappingBody" class="divide-y divide-slate-100 bg-white"></tbody>
                </table>
            </div>
        </div>

        <div id="step-dashboard" class="hidden max-w-[98%] mx-auto space-y-6 fade-in pb-10">
            <!-- Course Info Section -->
            <div class="bg-white rounded-xl shadow-lg border border-slate-200 p-6">
                <h3 class="font-bold text-slate-700 text-lg mb-4 flex items-center gap-2">
                    <i class="fas fa-info-circle text-blue-500"></i> Course Information
                </h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div>
                        <label class="text-xs uppercase font-bold text-slate-500 block mb-2">Subject</label>
                        <input type="text" id="inp-subject" placeholder="e.g., Mathematics" class="w-full border border-slate-300 rounded-lg p-3 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 shadow-sm" oninput="courseInfo.subject = this.value">
                    </div>
                    <div>
                        <label class="text-xs uppercase font-bold text-slate-500 block mb-2">Section</label>
                        <input type="text" id="inp-section" placeholder="e.g., A1 / Section 1" class="w-full border border-slate-300 rounded-lg p-3 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 shadow-sm" oninput="courseInfo.section = this.value">
                    </div>
                    <div>
                        <label class="text-xs uppercase font-bold text-slate-500 block mb-2">School Year</label>
                        <input type="text" id="inp-schoolyear" placeholder="e.g., 2025-2026" class="w-full border border-slate-300 rounded-lg p-3 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 shadow-sm" oninput="courseInfo.schoolYear = this.value">
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-2 md:grid-cols-4 gap-6">
                <div class="bg-white p-6 rounded-xl shadow-sm border-l-4 border-blue-500 hover:shadow-md transition">
                    <div class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-1">Class Average</div>
                    <div class="text-3xl font-bold text-slate-800" id="stat-avg">0.0</div>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-sm border-l-4 border-red-500 hover:shadow-md transition">
                    <div class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-1" id="stat-fail-label">Failed</div>
                    <div class="text-3xl font-bold text-slate-800" id="stat-fail">0</div>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-sm border-l-4 border-emerald-500 hover:shadow-md transition">
                    <div class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-1">Passing Rate</div>
                    <div class="text-3xl font-bold text-slate-800" id="stat-pass">0%</div>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-sm border-l-4 border-purple-500 hover:shadow-md transition">
                    <div class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-1">Total Students</div>
                    <div class="text-3xl font-bold text-slate-800" id="stat-total">0</div>
                </div>
            </div>

            <div class="bg-white rounded-xl shadow-lg border border-slate-200 overflow-hidden flex flex-col h-full">
                <div class="p-4 bg-slate-50 border-b flex flex-wrap gap-4 justify-between items-center">
                    <h3 class="font-bold text-slate-700 text-lg flex items-center gap-2">
                        <i class="fas fa-table text-slate-400"></i> Master Grade Sheet
                    </h3>
                    <div class="flex gap-4 items-center">
                        <button onclick="backToMapping()" class="text-xs font-bold text-slate-500 hover:text-blue-600 bg-white border border-slate-300 px-3 py-2 rounded hover:bg-blue-50 transition shadow-sm">
                            <i class="fas fa-pencil-alt mr-1"></i> Edit Mapping
                        </button>
                        <button onclick="exportExcel()" class="text-xs font-bold text-slate-700 hover:text-slate-900 bg-white border border-slate-300 px-3 py-2 rounded hover:bg-slate-50 transition shadow-sm">
                            <i class="fas fa-file-excel mr-1 text-emerald-600"></i> Export
                        </button>
                        <button onclick="printMaster()" class="text-xs font-bold text-slate-700 hover:text-slate-900 bg-white border border-slate-300 px-3 py-2 rounded hover:bg-slate-50 transition shadow-sm">
                            <i class="fas fa-print mr-1"></i> Print
                        </button>
                        <div class="relative">
                            <i class="fas fa-search absolute left-3 top-2.5 text-slate-400"></i>
                            <input type="text" id="searchInput" placeholder="Search student name..." class="pl-10 pr-4 py-2 border border-slate-300 rounded-full text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 w-64 shadow-sm bg-white transition focus:w-72">
                        </div>
                    </div>
                </div>
                
                <div class="overflow-auto max-h-[650px] table-container relative bg-slate-50">
                    <table class="w-full text-center text-xs border-collapse" id="masterTable">
                        <!-- Dynamic table based on mode -->
                    </table>
                </div>
                <div class="bg-white p-6 rounded-b-xl border-t border-slate-200 mt-4 print:visible invisible">
                    <div class="flex justify-between items-center">
                        <div class="w-1/3 text-center">
                            <div class="border-t-2 border-slate-800 pt-2 text-xs font-bold uppercase text-slate-800">Bemmygail Abanilla</div>
                            <div class="text-[10px] text-slate-500 uppercase tracking-wider">Course Instructor</div>
                        </div>
                        <div class="w-1/3 text-center">
                            <div class="border-t-2 border-slate-800 pt-2 text-xs font-bold uppercase text-slate-800">Academic Dean</div>
                            <div class="text-[10px] text-slate-500 uppercase tracking-wider">Verified By</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <div id="modalContainer" class="fixed inset-0 bg-slate-900 bg-opacity-80 z-[100] hidden flex items-center justify-center p-4 backdrop-blur-sm transition-opacity">
        <div class="bg-white w-full max-w-5xl rounded-2xl shadow-2xl overflow-hidden flex flex-col max-h-[95vh]">
            
            <div class="bg-slate-900 text-white px-6 py-4 flex justify-between items-center no-print flex-shrink-0">
                <h2 class="font-bold text-lg flex items-center gap-2"><i class="fas fa-id-card text-blue-400"></i> Student Report Card</h2>
                <div class="flex gap-3">
                    <button onclick="emailStudent()" class="bg-emerald-600 hover:bg-emerald-500 px-4 py-2 rounded text-xs uppercase font-bold tracking-wide transition shadow-lg mr-2">
                        <i class="fas fa-envelope mr-2"></i> Email Student
                    </button>
                    <button onclick="window.print()" class="bg-blue-600 hover:bg-blue-500 px-4 py-2 rounded text-xs uppercase font-bold tracking-wide transition shadow-lg hover:shadow-blue-500/50">
                        <i class="fas fa-print mr-2"></i> Print Report
                    </button>
                    <button onclick="copyEmailHTML()" class="bg-indigo-600 hover:bg-indigo-500 px-4 py-2 rounded text-xs uppercase font-bold tracking-wide transition shadow-lg hover:shadow-indigo-500/50">
                        <i class="fas fa-copy mr-2"></i> Copy Email HTML
                    </button>
                    <button onclick="closeModal()" class="bg-slate-700 hover:bg-slate-600 px-4 py-2 rounded text-xs uppercase font-bold tracking-wide transition">
                        <i class="fas fa-times mr-2"></i> Close
                    </button>
                </div>
            </div>

            <div class="p-10 overflow-y-auto print:overflow-visible bg-slate-50 print:bg-white print:p-8">
                
                <!-- Course Info Section -->
                <div class="flex justify-between items-center bg-blue-50 p-6 rounded-xl shadow-sm mb-6 border border-blue-200 break-inside-avoid">
                    <div class="flex gap-6 items-center flex-1">
                        <div>
                            <p class="text-[10px] text-slate-500 uppercase font-bold tracking-wider mb-1">Subject</p>
                            <h3 class="text-xl font-bold text-slate-800" id="rep-subject">--</h3>
                        </div>
                        <div class="border-l border-slate-300 pl-6">
                            <p class="text-[10px] text-slate-500 uppercase font-bold tracking-wider mb-1">Section</p>
                            <h3 class="text-xl font-bold text-slate-800" id="rep-section">--</h3>
                        </div>
                        <div class="border-l border-slate-300 pl-6">
                            <p class="text-[10px] text-slate-500 uppercase font-bold tracking-wider mb-1">School Year</p>
                            <h3 class="text-xl font-bold text-slate-800" id="rep-schoolyear">--</h3>
                        </div>
                    </div>
                </div>

                <!-- Student Info Section -->
                <div class="flex justify-between items-end border-b-2 border-slate-300 pb-6 mb-6 bg-white p-6 rounded-xl shadow-sm break-inside-avoid">
                    <div class="flex gap-6 items-center">
                        <div class="w-20 h-20 bg-gradient-to-br from-blue-100 to-indigo-100 rounded-full flex items-center justify-center text-blue-500 text-3xl border border-blue-200 shadow-inner">
                            <i class="fas fa-user-graduate"></i>
                        </div>
                        <div>
                            <p class="text-[10px] text-slate-400 uppercase font-bold tracking-wider mb-1">Student Name</p>
                            <h1 class="text-4xl font-bold text-slate-800 tracking-tight" id="rep-name">Last, First</h1>
                        </div>
                    </div>
                    <div class="text-right">
                        <div class="inline-block bg-slate-100 px-6 py-3 rounded-lg border border-slate-300">
                            <p class="text-[10px] text-slate-400 uppercase font-bold tracking-wider mb-1">Student ID</p>
                            <h3 class="text-2xl font-mono font-bold text-slate-700" id="rep-id">--</h3>
                        </div>
                    </div>
                </div>

                <!-- Grade Summary Section -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6 break-inside-avoid" id="reportGradeSummary">
                    <!-- Dynamic content based on mode -->
                </div>

                <!-- Detailed Activity Log -->
                <div class="mb-8 bg-white p-6 rounded-xl shadow-sm border border-slate-200">
                    <h4 class="font-bold text-slate-700 text-sm border-b border-slate-200 pb-3 mb-4 uppercase tracking-wide flex items-center gap-2">
                        <i class="fas fa-history text-blue-400"></i> Detailed Activity Log
                    </h4>
                    <div class="rounded-lg overflow-hidden border border-slate-200">
                        <div class="overflow-x-auto">
                            <table class="w-full text-xs text-left">
                                <thead class="bg-slate-50 text-slate-500 uppercase font-bold">
                                    <tr>
                                        <th class="p-3 w-28 border-b border-slate-200">Date</th>
                                        <th class="p-3 border-b border-slate-200">Activity Name</th>
                                        <th class="p-3 border-b border-slate-200">Category</th>
                                        <th class="p-3 text-right border-b border-slate-200">Score / Max</th>
                                        <th class="p-3 text-right border-b border-slate-200">Weight</th>
                                        <th class="p-3 text-center border-b border-slate-200" id="scale-header" style="display:none;">1-5 Scale</th>
                                    </tr>
                                </thead>
                                <tbody id="rep-details" class="divide-y divide-slate-100"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Attendance & Comments -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 p-6 rounded-xl border border-blue-200 bg-blue-50/50 mb-8 break-inside-avoid">
                    <div>
                        <h5 class="text-xs font-bold uppercase text-slate-500 mb-3 flex items-center gap-2"><i class="fas fa-clock"></i> Attendance & Bonus</h5>
                        <div class="flex gap-4 mb-2">
                            <div class="w-1/3">
                                <label class="text-[10px] uppercase font-bold text-slate-400 block mb-1">Present</label>
                                <input type="number" id="inp-att-present" class="w-full border-slate-300 rounded p-2 text-sm focus:ring-blue-500 focus:border-blue-500 bg-white shadow-sm font-mono" placeholder="0">
                            </div>
                            <div class="w-1/3">
                                <label class="text-[10px] uppercase font-bold text-slate-400 block mb-1">Absent</label>
                                <input type="number" id="inp-att-late" class="w-full border-slate-300 rounded p-2 text-sm focus:ring-blue-500 focus:border-blue-500 bg-white shadow-sm font-mono" placeholder="0">
                            </div>
                            <div class="w-1/3 relative">
                                <label class="text-[10px] uppercase font-bold text-emerald-600 block mb-1">Add Bonus (+)</label>
                                <input type="number" id="inp-bonus" step="0.01" class="w-full border-emerald-300 text-emerald-700 font-bold rounded p-2 text-sm focus:ring-emerald-500 focus:border-emerald-500 bg-white shadow-sm font-mono" placeholder="0">
                            </div>
                        </div>
                        <p class="text-[10px] text-emerald-600 italic mt-1">* Bonus is added directly to Grand Total</p>
                    </div>
                    <div>
                        <h5 class="text-xs font-bold uppercase text-slate-500 mb-3 flex items-center gap-2"><i class="fas fa-comment-alt"></i> Instructor Remarks</h5>
                        <textarea id="inp-comment" class="w-full border-slate-300 rounded p-3 text-xs h-24 resize-none focus:ring-blue-500 focus:border-blue-500 bg-white shadow-sm leading-relaxed" placeholder="Enter comments here... This will appear on the printed report card."></textarea>
                    </div>
                </div>

                <!-- Signature Section -->
                <div class="flex justify-between mt-12 pt-10 invisible print:visible break-inside-avoid">
                    <div class="w-1/3 text-center">
                        <div class="border-t-2 border-slate-800 pt-2 text-xs font-bold uppercase text-slate-800">Bemmygail Abanilla</div>
                        <div class="text-[10px] text-slate-500 uppercase tracking-wider">Course Instructor</div>
                    </div>
                    <div class="w-1/3 text-center">
                        <div class="border-t-2 border-slate-800 pt-2 text-xs font-bold uppercase text-slate-800">Academic Dean</div>
                        <div class="text-[10px] text-slate-500 uppercase tracking-wider">Verified By</div>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <script>
        // ============================================
        // GLOBAL CONFIGURATION & VARIABLES
        // ============================================
        
        let currentMode = null; // 'college' or 'shs'
        
        // College Mode Weights - MODIFY THESE PERCENTAGES HERE
        const COLLEGE_WEIGHTS = {
            lec: { quiz: 0.4, exam: 0.5, bonus: 0.1 },  // Lecture: Quiz 40%, Exam 50%, Bonus 10%
            lab: { quiz: 0.4, exam: 0.5, bonus: 0.1 },  // Lab: Quiz 40%, Exam 50%, Bonus 10%
            f2f: { lec: 0.4, lab: 0.6 },                // F2F: Lecture 40%, Lab 60%
            term: { lms: 0.4, f2f: 0.6 },               // Term: LMS 40%, F2F 60%
            grand: { prelim: 0.2, midterm: 0.2, prefinal: 0.2, final: 0.4 }  // Grand: Prelim 20%, Midterm 20%, PreFinal 20%, Finals 40%
        };

        // SHS Mode Weights - MODIFY THESE PERCENTAGES HERE
        const SHS_WEIGHTS = {
            quarter: { 
                written: 0.20,      // Written Work 20%
                performance: 0.60,  // Performance Task 60%
                assessment: 0.20    // Quarterly Assessment 20%
            },
            semester: { 
                q3: 0.5,  // Quarter 3: 50%
                q4: 0.5   // Quarter 4: 50%
            }
        };

        // --- GLOBAL VARIABLES ---
        let rawData = [];
        let headers = [];
        let headerDates = {};
        let maxPoints = {};
        let mapping = [];
        let students = [];
        let chartInstance = null;
        let currentStudentIdx = -1;
        let courseInfo = {
            subject: '',
            section: '',
            schoolYear: ''
        };

        // ============================================
        // MODE SELECTION
        // ============================================
        
        function selectMode(mode) {
            currentMode = mode;
            document.getElementById('step-mode-select').classList.add('hidden');
            document.getElementById('step-upload').classList.remove('hidden');
            
            const indicator = document.getElementById('modeIndicator');
            if(mode === 'college') {
                indicator.innerHTML = '<i class="fas fa-university mr-2"></i>College Mode Selected';
            } else {
                indicator.innerHTML = '<i class="fas fa-school mr-2"></i>Senior High School Mode Selected';
            }
        }

        function backToModeSelect() {
            document.getElementById('step-upload').classList.add('hidden');
            document.getElementById('step-mode-select').classList.remove('hidden');
            currentMode = null;
        }

        // ============================================
        // FILE UPLOAD & PARSING
        // ============================================
        
        document.getElementById('csvFile').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if(!file) return;

            document.getElementById('loader').classList.remove('hidden');
            document.getElementById('btnUploadText').innerText = "Parsing...";
            document.getElementById('errorBox').classList.add('hidden');

            Papa.parse(file, {
                header: false,
                skipEmptyLines: 'greedy',
                complete: function(results) {
                    try {
                        setTimeout(() => {
                            analyzeCSVStructure(results.data);
                            document.getElementById('loader').classList.add('hidden');
                            document.getElementById('btnUploadText').innerText = "Select CSV File";
                        }, 200);
                    } catch (err) {
                        showError(err.message);
                        document.getElementById('loader').classList.add('hidden');
                        document.getElementById('btnUploadText').innerText = "Select CSV File";
                    }
                },
                error: function(err) {
                    showError("CSV Error: " + err.message);
                }
            });
        });

        function showError(msg) {
            document.getElementById('errorBox').classList.remove('hidden');
            document.getElementById('errorText').innerText = msg;
        }

        // ============================================
        // DATA ANALYSIS
        // ============================================
        
        function analyzeCSVStructure(data) {
            let headerIdx = -1;
            for(let i=0; i<Math.min(data.length, 15); i++) {
                const str = data[i].join(' ').toLowerCase();
                if(str.includes('last name') && (str.includes('email') || str.includes('first name'))) {
                    headerIdx = i;
                    break;
                }
            }

            if(headerIdx === -1) throw new Error("Could not detect header row. Ensure CSV has 'Last Name' and 'Email' columns.");
            headers = data[headerIdx];

            let pointsRow = null, dateRow = null;
            for(let i = headerIdx + 1; i < Math.min(data.length, headerIdx + 6); i++) {
                const row = data[i];
                if(row[0] === "Points" || row.includes("Points")) pointsRow = row;
                else if(row[0] === "Date" || row.includes("Date")) dateRow = row;
            }

            headers.forEach((h, i) => {
                maxPoints[i] = pointsRow ? (parseFloat(pointsRow[i]) || 100) : 100;
                headerDates[i] = dateRow ? dateRow[i] : "-";
            });

            rawData = data.filter((row, i) => {
                if(i <= headerIdx) return false;
                if(row[0] === "Points" || row[0] === "Date") return false;
                return row[0] && row[0].length > 1;
            });

            buildMappingTable();
            
            document.getElementById('step-upload').classList.add('hidden');
            document.getElementById('step-mapping').classList.remove('hidden');
        }

        // ============================================
        // MAPPING INTERFACE
        // ============================================
        
        function buildMappingTable() {
            const headerRow = document.getElementById('mappingHeader');
            const tbody = document.getElementById('mappingBody');
            tbody.innerHTML = '';
            
            // Build header based on mode
            if(currentMode === 'college') {
                headerRow.innerHTML = `
                    <th class="p-4 border-b">Activity Name</th>
                    <th class="p-4 border-b w-32">Date</th>
                    <th class="p-4 border-b w-24">Max Pts</th>
                    <th class="p-4 border-b">Term</th>
                    <th class="p-4 border-b">Source</th>
                    <th class="p-4 border-b">Category</th>
                    <th class="p-4 border-b">Type</th>
                    <th class="p-4 border-b w-40">Action</th>
                `;
            } else {
                headerRow.innerHTML = `
                    <th class="p-4 border-b">Activity Name</th>
                    <th class="p-4 border-b w-32">Date</th>
                    <th class="p-4 border-b w-24">Max Pts</th>
                    <th class="p-4 border-b">Quarter</th>
                    <th class="p-4 border-b">Category</th>
                    <th class="p-4 border-b w-40">Action</th>
                `;
            }

            headers.forEach((h, i) => {
                if(["Last Name", "First Name", "Email Address"].some(k => h.includes(k))) return;

                const tr = document.createElement('tr');
                tr.className = "hover:bg-blue-50 transition border-b";
                tr.dataset.idx = i;

                let lowH = h.toLowerCase();
                let isID = lowH.includes("id") || lowH.includes("student number");
                let isAtt = lowH.includes("attendance");
                
                if(currentMode === 'college') {
                    buildCollegeMappingRow(tr, h, i, lowH, isID, isAtt);
                } else {
                    buildSHSMappingRow(tr, h, i, lowH, isID, isAtt);
                }
                
                tbody.appendChild(tr);
            });
        }

        function buildCollegeMappingRow(tr, h, i, lowH, isID, isAtt) {
            let defTerm = "prelim";
            if(lowH.includes("midterm")) defTerm = "midterm";
            else if(lowH.includes("prefinal") || lowH.includes("pre-final")) defTerm = "prefinal";
            else if(lowH.includes("final") && !lowH.includes("pre")) defTerm = "final";

            let defCat = lowH.includes("lab") ? "lab" : "lec";
            let defType = "quiz";
            if(lowH.includes("exam")) defType = "exam";
            else if(lowH.includes("bonus")) defType = "bonus";

            tr.innerHTML = `
                <td class="p-3 font-medium text-slate-700 truncate max-w-[200px]" title="${h}">${h}</td>
                <td class="p-3 text-xs text-slate-500">${headerDates[i]}</td>
                <td class="p-3 text-slate-500">${maxPoints[i]}</td>
                <td class="p-3">
                    <select class="map-term w-full border rounded text-xs p-1.5 bg-white shadow-sm">
                        <option value="prelim" ${defTerm==='prelim'?'selected':''}>Prelim</option>
                        <option value="midterm" ${defTerm==='midterm'?'selected':''}>Midterm</option>
                        <option value="prefinal" ${defTerm==='prefinal'?'selected':''}>Pre-Final</option>
                        <option value="final" ${defTerm==='final'?'selected':''}>Finals</option>
                    </select>
                </td>
                <td class="p-3">
                    <select class="map-source w-full border rounded text-xs p-1.5 bg-white shadow-sm" onchange="uiUpdate(this)">
                        <option value="f2f">F2F</option>
                        <option value="lms">LMS</option>
                    </select>
                </td>
                <td class="p-3">
                    <select class="map-cat w-full border rounded text-xs p-1.5 bg-white shadow-sm">
                        <option value="lec" ${defCat==='lec'?'selected':''}>Lecture</option>
                        <option value="lab" ${defCat==='lab'?'selected':''}>Lab</option>
                    </select>
                </td>
                <td class="p-3">
                    <select class="map-type w-full border rounded text-xs p-1.5 bg-white shadow-sm">
                        <option value="quiz" ${defType==='quiz'?'selected':''}>Quiz/Act (40%)</option>
                        <option value="exam" ${defType==='exam'?'selected':''}>Exam (50%)</option>
                        <option value="bonus" ${defType==='bonus'?'selected':''}>Bonus (10%)</option>
                    </select>
                </td>
                <td class="p-3">
                    <select class="map-action w-full border rounded text-xs font-bold p-1.5 bg-slate-50 shadow-sm" onchange="uiUpdate(this)">
                        <option value="grade" ${isID||isAtt?'':'selected'}>Grade</option>
                        <option value="id" ${isID?'selected':''}>Set as ID</option>
                        <option value="attendance" ${isAtt?'selected':''}>Attendance</option>
                        <option value="ignore">Ignore</option>
                    </select>
                </td>
            `;
            uiUpdate(tr.querySelector('.map-action'));
        }

        function buildSHSMappingRow(tr, h, i, lowH, isID, isAtt) {
            let defQuarter = "q3";
            if(lowH.includes("q4") || lowH.includes("quarter 4") || lowH.includes("4th quarter")) {
                defQuarter = "q4";
            }

            let defCat = "written";
            if(lowH.includes("performance") || lowH.includes("pt")) defCat = "performance";
            else if(lowH.includes("assessment") || lowH.includes("exam") || lowH.includes("qa")) defCat = "assessment";

            tr.innerHTML = `
                <td class="p-3 font-medium text-slate-700 truncate max-w-[200px]" title="${h}">${h}</td>
                <td class="p-3 text-xs text-slate-500">${headerDates[i]}</td>
                <td class="p-3 text-slate-500">${maxPoints[i]}</td>
                <td class="p-3">
                    <select class="map-quarter w-full border rounded text-xs p-1.5 bg-white shadow-sm">
                        <option value="q3" ${defQuarter==='q3'?'selected':''}>Quarter 3</option>
                        <option value="q4" ${defQuarter==='q4'?'selected':''}>Quarter 4</option>
                    </select>
                </td>
                <td class="p-3">
                    <select class="map-category w-full border rounded text-xs p-1.5 bg-white shadow-sm">
                        <option value="written" ${defCat==='written'?'selected':''}>Written Work (20%)</option>
                        <option value="performance" ${defCat==='performance'?'selected':''}>Performance Task (60%)</option>
                        <option value="assessment" ${defCat==='assessment'?'selected':''}>Quarterly Assessment (20%)</option>
                    </select>
                </td>
                <td class="p-3">
                    <select class="map-action w-full border rounded text-xs font-bold p-1.5 bg-slate-50 shadow-sm" onchange="uiUpdate(this)">
                        <option value="grade" ${isID||isAtt?'':'selected'}>Grade</option>
                        <option value="id" ${isID?'selected':''}>Set as ID</option>
                        <option value="attendance" ${isAtt?'selected':''}>Attendance</option>
                        <option value="ignore">Ignore</option>
                    </select>
                </td>
            `;
            uiUpdate(tr.querySelector('.map-action'));
        }

        function uiUpdate(el) {
            const tr = el.closest('tr');
            const action = tr.querySelector('.map-action').value;
            const selects = tr.querySelectorAll('select:not(.map-action)');

            if(action !== 'grade') {
                selects.forEach(s => s.disabled = true);
                tr.classList.add('opacity-50');
            } else {
                selects.forEach(s => s.disabled = false);
                tr.classList.remove('opacity-50');
                
                if(currentMode === 'college') {
                    const source = tr.querySelector('.map-source');
                    if(source && source.value === 'lms') {
                        tr.querySelector('.map-cat').disabled = true;
                        tr.querySelector('.map-type').disabled = true;
                    }
                }
            }
        }

        // ============================================
        // CALCULATION CORE
        // ============================================
        
        function processGrades() {
            if(currentMode === 'college') {
                processCollegeGrades();
            } else {
                processSHSGrades();
            }
            
            renderDashboard();
            document.getElementById('step-mapping').classList.add('hidden');
            document.getElementById('step-dashboard').classList.remove('hidden');
        }

        function processCollegeGrades() {
            mapping = Array.from(document.querySelectorAll('#mappingBody tr')).map(tr => ({
                idx: parseInt(tr.dataset.idx),
                name: tr.cells[0].innerText,
                date: tr.cells[1].innerText,
                max: parseFloat(tr.cells[2].innerText),
                term: tr.querySelector('.map-term')?.value,
                source: tr.querySelector('.map-source')?.value,
                cat: tr.querySelector('.map-cat')?.value,
                type: tr.querySelector('.map-type')?.value,
                action: tr.querySelector('.map-action').value
            }));

            const nameIdx = headers.findIndex(h => h.toLowerCase().includes("last name"));
            const firstIdx = headers.findIndex(h => h.toLowerCase().includes("first name"));
            const emailIdx = headers.findIndex(h => h.toLowerCase().includes("email"));
            const idMap = mapping.find(m => m.action === 'id');

            students = rawData.map(row => {
                let s = {
                    name: `${row[nameIdx]}, ${row[firstIdx]}`,
                    id: idMap ? row[idMap.idx] : "N/A",
                    email: emailIdx !== -1 ? (row[emailIdx] || '') : '',
                    attendance: 0,
                    bonusPoints: 0,
                    terms: {},
                    calculatedGrandTotal: 0,
                    grandTotal: 0,
                    history: []
                };

                ['prelim','midterm','prefinal','final'].forEach(t => {
                    s.terms[t] = { 
                        lms: { s:0, m:0 }, 
                        f2f: { lec:{quiz:{s:0,m:0}, exam:{s:0,m:0}, bonus:{s:0,m:0}}, lab:{quiz:{s:0,m:0}, exam:{s:0,m:0}, bonus:{s:0,m:0}} }
                    };
                });

                mapping.forEach(m => {
                    let val = parseFloat(row[m.idx]) || 0;
                    
                    if(m.action === 'attendance') {
                        if(val > 0 || (row[m.idx] && row[m.idx].toLowerCase().includes('p'))) s.attendance++;
                    } else if(m.action === 'grade') {
                        let weightLog = 0;
                        if(m.source === 'lms') weightLog = 40; 
                        else {
                            let catW = m.cat === 'lec' ? 0.4 : 0.6;
                            let typeW = COLLEGE_WEIGHTS[m.cat][m.type];
                            weightLog = (0.6 * catW * typeW * 100).toFixed(1);
                        }

                        s.history.push({
                            date: m.date, name: m.name, term: m.term, 
                            cat: m.cat, type: m.type, score: val, max: m.max,
                            weight: weightLog, source: m.source
                        });

                        let t = s.terms[m.term];
                        if(m.source === 'lms') {
                            t.lms.s += val; t.lms.m += m.max;
                        } else {
                            t.f2f[m.cat][m.type].s += val;
                            t.f2f[m.cat][m.type].m += m.max;
                        }
                    }
                });

                ['prelim','midterm','prefinal','final'].forEach(tKey => {
                    let t = s.terms[tKey];
                    let lmsG = t.lms.m > 0 ? (t.lms.s / t.lms.m)*100 : 0;
                    t.lmsFinal = lmsG;

                    const calc = (b) => b.m > 0 ? (b.s / b.m)*100 : 0;
                    
                    let lecG = (calc(t.f2f.lec.quiz) * COLLEGE_WEIGHTS.lec.quiz) + (calc(t.f2f.lec.exam) * COLLEGE_WEIGHTS.lec.exam) + (calc(t.f2f.lec.bonus) * COLLEGE_WEIGHTS.lec.bonus);
                    let labG = (calc(t.f2f.lab.quiz) * COLLEGE_WEIGHTS.lab.quiz) + (calc(t.f2f.lab.exam) * COLLEGE_WEIGHTS.lab.exam) + (calc(t.f2f.lab.bonus) * COLLEGE_WEIGHTS.lab.bonus);
                    
                    let f2fG = (lecG * COLLEGE_WEIGHTS.f2f.lec) + (labG * COLLEGE_WEIGHTS.f2f.lab);
                    t.f2fFinal = f2fG;
                    t.lecFinal = lecG;
                    t.labFinal = labG;

                    t.final = (lmsG * COLLEGE_WEIGHTS.term.lms) + (f2fG * COLLEGE_WEIGHTS.term.f2f);
                });

                s.calculatedGrandTotal = (s.terms.prelim.final * COLLEGE_WEIGHTS.grand.prelim) + 
                               (s.terms.midterm.final * COLLEGE_WEIGHTS.grand.midterm) + 
                               (s.terms.prefinal.final * COLLEGE_WEIGHTS.grand.prefinal) + 
                               (s.terms.final.final * COLLEGE_WEIGHTS.grand.final);
                
                s.grandTotal = s.calculatedGrandTotal;
                s.transmuted = transmute(s.grandTotal);
                return s;
            });
        }

        function processSHSGrades() {
            mapping = Array.from(document.querySelectorAll('#mappingBody tr')).map(tr => ({
                idx: parseInt(tr.dataset.idx),
                name: tr.cells[0].innerText,
                date: tr.cells[1].innerText,
                max: parseFloat(tr.cells[2].innerText),
                quarter: tr.querySelector('.map-quarter')?.value,
                category: tr.querySelector('.map-category')?.value,
                action: tr.querySelector('.map-action').value
            }));

            const nameIdx = headers.findIndex(h => h.toLowerCase().includes("last name"));
            const firstIdx = headers.findIndex(h => h.toLowerCase().includes("first name"));
            const emailIdx = headers.findIndex(h => h.toLowerCase().includes("email"));
            const idMap = mapping.find(m => m.action === 'id');

            students = rawData.map(row => {
                let s = {
                    name: `${row[nameIdx]}, ${row[firstIdx]}`,
                    id: idMap ? row[idMap.idx] : "N/A",
                    email: emailIdx !== -1 ? (row[emailIdx] || '') : '',
                    attendance: 0,
                    bonusPoints: 0,
                    quarters: {
                        q3: { written: {s:0, m:0}, performance: {s:0, m:0}, assessment: {s:0, m:0} },
                        q4: { written: {s:0, m:0}, performance: {s:0, m:0}, assessment: {s:0, m:0} }
                    },
                    calculatedGrandTotal: 0,
                    grandTotal: 0,
                    history: []
                };

                mapping.forEach(m => {
                    let val = parseFloat(row[m.idx]) || 0;
                    
                    if(m.action === 'attendance') {
                        if(val > 0 || (row[m.idx] && row[m.idx].toLowerCase().includes('p'))) s.attendance++;
                    } else if(m.action === 'grade') {
                        let weightPct = 0;
                        if(m.category === 'written') weightPct = 20;
                        else if(m.category === 'performance') weightPct = 60;
                        else if(m.category === 'assessment') weightPct = 20;

                        s.history.push({
                            date: m.date,
                            name: m.name,
                            quarter: m.quarter,
                            category: m.category,
                            score: val,
                            max: m.max,
                            weight: weightPct
                        });

                        let q = s.quarters[m.quarter];
                        q[m.category].s += val;
                        q[m.category].m += m.max;
                    }
                });

                // Calculate quarter grades
                ['q3', 'q4'].forEach(qKey => {
                    let q = s.quarters[qKey];
                    const calc = (cat) => cat.m > 0 ? (cat.s / cat.m) * 100 : 0;
                    
                    q.writtenGrade = calc(q.written);
                    q.performanceGrade = calc(q.performance);
                    q.assessmentGrade = calc(q.assessment);
                    
                    q.final = (q.writtenGrade * SHS_WEIGHTS.quarter.written) + 
                              (q.performanceGrade * SHS_WEIGHTS.quarter.performance) + 
                              (q.assessmentGrade * SHS_WEIGHTS.quarter.assessment);
                });

                s.calculatedGrandTotal = (s.quarters.q3.final * SHS_WEIGHTS.semester.q3) + 
                                        (s.quarters.q4.final * SHS_WEIGHTS.semester.q4);
                
                s.grandTotal = s.calculatedGrandTotal;
                s.transmuted = s.grandTotal.toFixed(2); // No transmutation for SHS
                return s;
            });
        }

        function transmute(g) {
            if(g >= 97) return "1.0";
            if(g < 50) return "5.0";
            return (3.0 - ((g-50)/50)*2.0).toFixed(2);
        }

        // Letter grade and remark helper (Custom Scale)
        function convertTo1to5Scale(percentage) {
            // 1 = 100%, 5 = below 50%
            // Linear scale from 1 to 5
            if(percentage >= 100) return 1.0;
            if(percentage <= 50) return 5.0;
            // Linear interpolation: 1 + (4 * (100 - percentage) / 50)
            return 1 + (4 * (100 - percentage) / 50);
        }

        function gradeLetter(g) {
            const n = parseFloat(g) || 0;
            if(n >= 96) return { letter: 'A+', remark: 'Excellent', transmuted: '1' };
            if(n >= 91) return { letter: 'A', remark: 'Very Good', transmuted: '1.25' };
            if(n >= 86) return { letter: 'A-', remark: 'Very Good', transmuted: '1.5' };
            if(n >= 81) return { letter: 'B+', remark: 'Good', transmuted: '1.75' };
            if(n >= 75) return { letter: 'B', remark: 'Good', transmuted: '2' };
            if(n >= 69) return { letter: 'B-', remark: 'Good', transmuted: '2.25' };
            if(n >= 63) return { letter: 'C+', remark: 'Fair', transmuted: '2.5' };
            if(n >= 57) return { letter: 'C', remark: 'Fair', transmuted: '2.75' };
            if(n >= 50) return { letter: 'C-', remark: 'Fair', transmuted: '3' };
            return { letter: 'F', remark: 'Failed', transmuted: '5' };
        }

        // ============================================
        // RENDER DASHBOARD
        // ============================================
        
        function renderDashboard() {
            if(currentMode === 'college') {
                renderCollegeDashboard();
            } else {
                renderSHSDashboard();
            }
        }

        function renderCollegeDashboard() {
            let avg = students.reduce((a,b)=>a+b.grandTotal,0) / students.length || 0;
            document.getElementById('stat-avg').innerText = transmute(avg);
            document.getElementById('stat-fail').innerText = students.filter(s=>s.grandTotal<50).length;
            document.getElementById('stat-fail-label').innerText = "Failed (5.0)";
            document.getElementById('stat-pass').innerText = Math.round((students.filter(s=>s.grandTotal>=50).length/students.length)*100) + "%";
            document.getElementById('stat-total').innerText = students.length;

            const table = document.getElementById('masterTable');
            table.innerHTML = `
                <thead class="bg-slate-100 text-slate-600 uppercase font-bold z-40">
                    <tr>
                        <th rowspan="2" class="p-3 text-left sticky-left-1 min-w-[220px] border-r border-b shadow-[2px_0_5px_-2px_rgba(0,0,0,0.1)] cursor-pointer hover:bg-slate-200 bg-white" onclick="sortTable('name')">
                            Student Name <i class="fas fa-sort ml-1 text-slate-400"></i>
                        </th>
                        <th rowspan="2" class="p-3 border-r border-b min-w-[100px] bg-white text-slate-500">ID No.</th>
                        
                        <th colspan="4" class="p-1 border-r border-b bg-blue-50 text-blue-800 tracking-wider">Prelim (20%)</th>
                        <th colspan="4" class="p-1 border-r border-b bg-green-50 text-green-800 tracking-wider">Midterm (20%)</th>
                        <th colspan="4" class="p-1 border-r border-b bg-orange-50 text-orange-800 tracking-wider">Pre-Final (20%)</th>
                        <th colspan="4" class="p-1 border-r border-b bg-purple-50 text-purple-800 tracking-wider">Finals (40%)</th>
                        
                                <th rowspan="2" class="p-3 border-l border-b bg-slate-800 text-white cursor-pointer hover:bg-slate-700 min-w-[80px]" onclick="sortTable('grade')">
                                    Final <i class="fas fa-sort ml-1 text-slate-400"></i>
                                </th>
                                <th rowspan="2" class="p-3 border-l border-b bg-slate-700 text-white min-w-[80px]">Letter</th>
                                <th rowspan="2" class="p-3 border-b min-w-[140px] bg-slate-100">Remark</th>
                                <th rowspan="2" class="p-3 border-b min-w-[100px] bg-slate-100">Actions</th>
                    </tr>
                    <tr class="text-[10px] tracking-tight font-semibold">
                        <th class="bg-blue-50 border-b text-slate-500 py-2 w-12">LMS</th>
                        <th class="bg-blue-50 border-b text-slate-500 py-2 w-12" title="F2F Lecture">Lec</th>
                        <th class="bg-blue-50 border-b text-slate-500 py-2 w-12" title="F2F Lab">Lab</th>
                        <th class="bg-blue-100 border-r border-b font-bold py-2 w-12 text-blue-900">TOT</th>
                        
                        <th class="bg-green-50 border-b text-slate-500 py-2 w-12">LMS</th>
                        <th class="bg-green-50 border-b text-slate-500 py-2 w-12">Lec</th>
                        <th class="bg-green-50 border-b text-slate-500 py-2 w-12">Lab</th>
                        <th class="bg-green-100 border-r border-b font-bold py-2 w-12 text-green-900">TOT</th>

                        <th class="bg-orange-50 border-b text-slate-500 py-2 w-12">LMS</th>
                        <th class="bg-orange-50 border-b text-slate-500 py-2 w-12">Lec</th>
                        <th class="bg-orange-50 border-b text-slate-500 py-2 w-12">Lab</th>
                        <th class="bg-orange-100 border-r border-b font-bold py-2 w-12 text-orange-900">TOT</th>

                        <th class="bg-purple-50 border-b text-slate-500 py-2 w-12">LMS</th>
                        <th class="bg-purple-50 border-b text-slate-500 py-2 w-12">Lec</th>
                        <th class="bg-purple-50 border-b text-slate-500 py-2 w-12">Lab</th>
                        <th class="bg-purple-100 border-r border-b font-bold py-2 w-12 text-purple-900">TOT</th>
                    </tr>
                </thead>
                <tbody id="masterBody" class="divide-y divide-slate-100 bg-white"></tbody>
            `;

            const tbody = document.getElementById('masterBody');
            students.forEach((s, i) => {
                const tr = document.createElement('tr');
                tr.className = "hover:bg-blue-50 border-b group transition text-slate-700";
                
                let termCols = ['prelim','midterm','prefinal','final'].map(t => {
                    let term = s.terms[t];
                    return `
                        <td class="text-xs text-slate-400 border-l py-2">${term.lmsFinal.toFixed(0)}</td>
                        <td class="text-xs text-slate-400 py-2">${term.lecFinal.toFixed(0)}</td>
                        <td class="text-xs text-slate-400 py-2">${term.labFinal.toFixed(0)}</td>
                        <td class="text-xs font-bold text-slate-700 bg-slate-50 border-r py-2">${term.final.toFixed(0)}</td>
                    `;
                }).join('');

                tr.innerHTML = `
                    <td class="p-3 text-left font-medium text-slate-900 sticky-left-1 border-r border-b group-hover:bg-blue-50 shadow-[2px_0_5px_-2px_rgba(0,0,0,0.1)] bg-white">${s.name}</td>
                    <td class="p-3 text-xs border-r text-slate-500 bg-white font-mono">${s.id}</td>
                    ${termCols}
                    <td class="p-3 font-bold text-lg ${s.grandTotal < 50 ? 'text-red-600':'text-emerald-600'} border-l border-b bg-white">${s.transmuted}</td>
                    <td class="p-3 text-center border-l bg-white font-bold">${gradeLetter(s.grandTotal).letter}</td>
                    <td class="p-3 text-center bg-white">${gradeLetter(s.grandTotal).remark}</td>
                    <td class="p-3 text-right bg-white border-b">
                        <button onclick="viewReport(${i})" class="text-blue-600 hover:text-blue-800 bg-blue-50 hover:bg-blue-100 p-2 rounded mr-1 transition"><i class="fas fa-eye"></i></button>
                        <button onclick="deleteRow(${i})" class="text-red-400 hover:text-red-600 bg-red-50 hover:bg-red-100 p-2 rounded transition"><i class="fas fa-trash"></i></button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        function renderSHSDashboard() {
            let avg = students.reduce((a,b)=>a+b.grandTotal,0) / students.length || 0;
            document.getElementById('stat-avg').innerText = avg.toFixed(2);
            document.getElementById('stat-fail').innerText = students.filter(s=>s.grandTotal<75).length;
            document.getElementById('stat-fail-label').innerText = "Below 75";
            document.getElementById('stat-pass').innerText = Math.round((students.filter(s=>s.grandTotal>=75).length/students.length)*100) + "%";
            document.getElementById('stat-total').innerText = students.length;

            const table = document.getElementById('masterTable');
            table.innerHTML = `
                <thead class="bg-slate-100 text-slate-600 uppercase font-bold z-40">
                    <tr>
                        <th rowspan="2" class="p-3 text-left sticky-left-1 min-w-[220px] border-r border-b shadow-[2px_0_5px_-2px_rgba(0,0,0,0.1)] cursor-pointer hover:bg-slate-200 bg-white" onclick="sortTable('name')">
                            Student Name <i class="fas fa-sort ml-1 text-slate-400"></i>
                        </th>
                        <th rowspan="2" class="p-3 border-r border-b min-w-[100px] bg-white text-slate-500">ID No.</th>
                        
                        <th colspan="4" class="p-1 border-r border-b bg-blue-50 text-blue-800 tracking-wider">Quarter 3 (50%)</th>
                        <th colspan="4" class="p-1 border-r border-b bg-emerald-50 text-emerald-800 tracking-wider">Quarter 4 (50%)</th>
                        
                        <th rowspan="2" class="p-3 border-l border-b bg-slate-800 text-white cursor-pointer hover:bg-slate-700 min-w-[80px]" onclick="sortTable('grade')">
                            Semestral <i class="fas fa-sort ml-1 text-slate-400"></i>
                        </th>
                        <th rowspan="2" class="p-3 border-l border-b bg-slate-700 text-white min-w-[80px]">Letter</th>
                        <th rowspan="2" class="p-3 border-b min-w-[140px] bg-slate-100">Remark</th>
                        <th rowspan="2" class="p-3 border-b min-w-[100px] bg-slate-100">Actions</th>
                    </tr>
                    <tr class="text-[10px] tracking-tight font-semibold">
                        <th class="bg-blue-50 border-b text-slate-500 py-2 w-12" title="Written Work">WW</th>
                        <th class="bg-blue-50 border-b text-slate-500 py-2 w-12" title="Performance Task">PT</th>
                        <th class="bg-blue-50 border-b text-slate-500 py-2 w-12" title="Quarterly Assessment">QA</th>
                        <th class="bg-blue-100 border-r border-b font-bold py-2 w-12 text-blue-900">Grade</th>
                        
                        <th class="bg-emerald-50 border-b text-slate-500 py-2 w-12">WW</th>
                        <th class="bg-emerald-50 border-b text-slate-500 py-2 w-12">PT</th>
                        <th class="bg-emerald-50 border-b text-slate-500 py-2 w-12">QA</th>
                        <th class="bg-emerald-100 border-r border-b font-bold py-2 w-12 text-emerald-900">Grade</th>
                    </tr>
                </thead>
                <tbody id="masterBody" class="divide-y divide-slate-100 bg-white"></tbody>
            `;

            const tbody = document.getElementById('masterBody');
            students.forEach((s, i) => {
                const tr = document.createElement('tr');
                tr.className = "hover:bg-blue-50 border-b group transition text-slate-700";

                tr.innerHTML = `
                    <td class="p-3 text-left font-medium text-slate-900 sticky-left-1 border-r border-b group-hover:bg-blue-50 shadow-[2px_0_5px_-2px_rgba(0,0,0,0.1)] bg-white">${s.name}</td>
                    <td class="p-3 text-xs border-r text-slate-500 bg-white font-mono">${s.id}</td>
                    <td class="text-xs text-slate-400 border-l py-2">${s.quarters.q3.writtenGrade.toFixed(0)}</td>
                    <td class="text-xs text-slate-400 py-2">${s.quarters.q3.performanceGrade.toFixed(0)}</td>
                    <td class="text-xs text-slate-400 py-2">${s.quarters.q3.assessmentGrade.toFixed(0)}</td>
                    <td class="text-xs font-bold text-slate-700 bg-slate-50 border-r py-2">${s.quarters.q3.final.toFixed(0)}</td>
                    <td class="text-xs text-slate-400 border-l py-2">${s.quarters.q4.writtenGrade.toFixed(0)}</td>
                    <td class="text-xs text-slate-400 py-2">${s.quarters.q4.performanceGrade.toFixed(0)}</td>
                    <td class="text-xs text-slate-400 py-2">${s.quarters.q4.assessmentGrade.toFixed(0)}</td>
                    <td class="text-xs font-bold text-slate-700 bg-slate-50 border-r py-2">${s.quarters.q4.final.toFixed(0)}</td>
                    <td class="p-3 font-bold text-lg ${s.grandTotal < 75 ? 'text-red-600':'text-emerald-600'} border-l border-b bg-white">${s.transmuted}</td>
                    <td class="p-3 text-center border-l bg-white font-bold">${gradeLetter(s.grandTotal).letter}</td>
                    <td class="p-3 text-center bg-white">${gradeLetter(s.grandTotal).remark}</td>
                    <td class="p-3 text-right bg-white border-b">
                        <button onclick="viewReport(${i})" class="text-blue-600 hover:text-blue-800 bg-blue-50 hover:bg-blue-100 p-2 rounded mr-1 transition"><i class="fas fa-eye"></i></button>
                        <button onclick="deleteRow(${i})" class="text-red-400 hover:text-red-600 bg-red-50 hover:bg-red-100 p-2 rounded transition"><i class="fas fa-trash"></i></button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        function deleteRow(idx) {
            if(confirm("Are you sure you want to remove this student?")) {
                students.splice(idx, 1);
                renderDashboard();
            }
        }

        function backToMapping() {
            document.getElementById('step-dashboard').classList.add('hidden');
            document.getElementById('step-mapping').classList.remove('hidden');
        }

        // ============================================
        // REPORT MODAL
        // ============================================
        
   

        function viewReport(idx) {
            currentStudentIdx = idx;
            const s = students[idx];
            document.getElementById('modalContainer').classList.remove('hidden');

            document.getElementById('rep-name').innerText = s.name;
            document.getElementById('rep-id').innerText = s.id;
            
            document.getElementById('inp-att-present').value = s.attendance;
            document.getElementById('inp-bonus').value = s.bonusPoints > 0 ? s.bonusPoints : "";

            if(currentMode === 'college') {
                renderCollegeReport(s);
            } else {
                renderSHSReport(s);
            }

            updateReportVisuals(s);
        }

        function closeModal() {
        document.getElementById('modalContainer').classList.add('hidden');
        }  

        function renderCollegeReport(s) {
            // Update course info
            document.getElementById('rep-subject').innerText = courseInfo.subject || '--';
            document.getElementById('rep-section').innerText = courseInfo.section || '--';
            document.getElementById('rep-schoolyear').innerText = courseInfo.schoolYear || '--';

            const summarySection = document.getElementById('reportGradeSummary');
            summarySection.innerHTML = `
                <div class="md:col-span-1 bg-gradient-to-br from-white to-blue-50 rounded-xl p-8 border-2 border-blue-200 text-center shadow-md flex flex-col justify-center items-center relative overflow-hidden">
                    <div class="absolute top-0 left-0 w-full h-1.5 bg-gradient-to-r from-blue-500 to-indigo-600"></div>
                    <p class="text-xs font-bold text-blue-600 uppercase tracking-widest mb-2">Final Grade</p>
                    <div class="text-8xl font-black text-slate-800 mb-1 tracking-tighter" id="rep-grade">1.0</div>
                        <div class="text-xl font-medium text-slate-500" id="rep-percent">98.5%</div>
                        <div class="mt-2 text-sm" id="rep-letter">A  Excellent</div>
                        <div class="mt-6 text-[10px] text-slate-400 bg-white px-3 py-1 rounded-full shadow-sm border border-slate-200">Base-50 Scale</div>
                </div>

                <div class="md:col-span-2 flex flex-col md:flex-row gap-6 bg-white p-6 rounded-xl shadow-sm border-2 border-slate-200">
                    <div class="flex-grow">
                        <h4 class="font-bold text-slate-700 text-sm border-b border-slate-200 pb-3 mb-3 uppercase tracking-wide flex items-center gap-2">
                            <i class="fas fa-list-ol text-blue-400"></i> Term Summary
                        </h4>
                        <table class="w-full text-sm">
                            <thead class="bg-slate-50 text-xs text-slate-500 uppercase font-bold">
                                <tr>
                                    <th class="p-2 text-left rounded-l-md">Term</th>
                                    <th class="p-2 text-center">LMS</th>
                                    <th class="p-2 text-center">F2F (Lec/Lab)</th>
                                    <th class="p-2 text-center">Total</th>
                                    <th class="p-2 text-center rounded-r-md">1-5 Scale</th>
                                </tr>
                            </thead>
                            <tbody id="rep-term-rows" class="divide-y divide-slate-100 text-slate-700"></tbody>
                        </table>
                    </div>
                    <div class="w-full md:w-1/3 flex items-center justify-center h-48 relative border-l border-slate-200 pl-4">
                        <canvas id="gradeChart"></canvas>
                    </div>
                </div>
            `;

            document.getElementById('rep-term-rows').innerHTML = ['prelim','midterm','prefinal','final'].map(t => {
                const termScale = convertTo1to5Scale(s.terms[t].final);
                return `
                <tr class="border-b transition hover:bg-slate-50">
                    <td class="p-3 capitalize font-medium text-slate-700">${t}</td>
                    <td class="p-3 text-center text-slate-500">${s.terms[t].lmsFinal.toFixed(1)}</td>
                    <td class="p-3 text-center text-slate-500">${s.terms[t].f2fFinal.toFixed(1)} <span class="text-[10px] text-slate-400">(${s.terms[t].lecFinal.toFixed(0)}/${s.terms[t].labFinal.toFixed(0)})</span></td>
                    <td class="p-3 text-center font-bold text-slate-900">${s.terms[t].final.toFixed(1)}</td>
                    <td class="p-3 text-center font-bold text-slate-700">${termScale.toFixed(1)}</td>
                </tr>
            `;
            }).join('');

            // Show 1-5 scale header for college mode
            document.getElementById('scale-header').style.display = 'table-cell';
            
            document.getElementById('rep-details').innerHTML = s.history.map(h => {
                const percentage = (h.score / h.max) * 100;
                const scale1to5 = convertTo1to5Scale(percentage);
                return `
                <tr class="hover:bg-slate-50 border-b">
                    <td class="p-3 text-slate-500 text-[11px]">${h.date}</td>
                    <td class="p-3 font-medium text-slate-700 truncate max-w-[200px]" title="${h.name}">${h.name}</td>
                    <td class="p-3">
                        <span class="px-2 py-1 rounded text-[10px] font-bold uppercase ${h.source==='lms'?'bg-blue-100 text-blue-700':'bg-emerald-100 text-emerald-700'}">
                            ${h.source}  ${h.cat}  ${h.type}
                        </span>
                    </td>
                    <td class="p-3 text-right font-mono text-slate-600">${h.score} / ${h.max}</td>
                    <td class="p-3 text-right text-xs text-slate-400">${h.weight}%</td>
                    <td class="p-3 text-center font-bold text-slate-700">${scale1to5.toFixed(1)}</td>
                </tr>
            `;
            }).join('');

            const ctx = document.getElementById('gradeChart').getContext('2d');
            if(chartInstance) chartInstance.destroy();
            chartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Prelim', 'Midterm', 'PreFinal', 'Final'],
                    datasets: [{
                        data: [s.terms.prelim.final*0.2, s.terms.midterm.final*0.2, s.terms.prefinal.final*0.2, s.terms.final.final*0.4],
                        backgroundColor: ['#3b82f6', '#10b981', '#f97316', '#8b5cf6'],
                        borderWidth: 2, borderColor: '#ffffff'
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false, cutout: '70%', plugins: { legend: { display: false } } }
            });
        }

        function renderSHSReport(s) {
            // Update course info
            document.getElementById('rep-subject').innerText = courseInfo.subject || '--';
            document.getElementById('rep-section').innerText = courseInfo.section || '--';
            document.getElementById('rep-schoolyear').innerText = courseInfo.schoolYear || '--';

            const summarySection = document.getElementById('reportGradeSummary');
            summarySection.innerHTML = `
                <div class="md:col-span-1 bg-gradient-to-br from-white to-emerald-50 rounded-xl p-8 border-2 border-emerald-200 text-center shadow-md flex flex-col justify-center items-center relative overflow-hidden">
                    <div class="absolute top-0 left-0 w-full h-1.5 bg-gradient-to-r from-emerald-500 to-teal-600"></div>
                    <p class="text-xs font-bold text-emerald-600 uppercase tracking-widest mb-2">Semestral Grade</p>
                    <div class="text-8xl font-black text-slate-800 mb-1 tracking-tighter" id="rep-grade">85</div>
                    <div class="mt-2 text-sm" id="rep-letter">B  Very Good</div>
                    <div class="mt-6 text-[10px] text-slate-400 bg-white px-3 py-1 rounded-full shadow-sm border border-slate-200">1-100 Scale</div>
                </div>

                <div class="md:col-span-2 bg-white p-6 rounded-xl shadow-sm border-2 border-slate-200">
                    <h4 class="font-bold text-slate-700 text-sm border-b border-slate-200 pb-3 mb-3 uppercase tracking-wide flex items-center gap-2">
                        <i class="fas fa-list-ol text-emerald-400"></i> Quarter Summary
                    </h4>
                    <table class="w-full text-sm">
                        <thead class="bg-slate-50 text-xs text-slate-500 uppercase font-bold">
                            <tr>
                                <th class="p-2 text-left rounded-l-md">Quarter</th>
                                <th class="p-2 text-center">Written</th>
                                <th class="p-2 text-center">Performance</th>
                                <th class="p-2 text-center">Assessment</th>
                                <th class="p-2 text-right rounded-r-md">Grade</th>
                            </tr>
                        </thead>
                        <tbody id="rep-quarter-rows" class="divide-y divide-slate-100 text-slate-700"></tbody>
                    </table>
                </div>
            `;

            document.getElementById('rep-quarter-rows').innerHTML = ['q3','q4'].map(q => {
                const qData = s.quarters[q];
                return `
                    <tr class="border-b transition hover:bg-slate-50">
                        <td class="p-3 capitalize font-medium text-slate-700">${q === 'q3' ? 'Quarter 3' : 'Quarter 4'}</td>
                        <td class="p-3 text-center text-slate-500">${qData.writtenGrade.toFixed(1)}</td>
                        <td class="p-3 text-center text-slate-500">${qData.performanceGrade.toFixed(1)}</td>
                        <td class="p-3 text-center text-slate-500">${qData.assessmentGrade.toFixed(1)}</td>
                        <td class="p-3 text-right font-bold text-slate-900">${qData.final.toFixed(1)}</td>
                    </tr>
                `;
            }).join('');

            // Hide 1-5 scale header for SHS mode
            document.getElementById('scale-header').style.display = 'none';

            document.getElementById('rep-details').innerHTML = s.history.map(h => `
                <tr class="hover:bg-slate-50 border-b">
                    <td class="p-3 text-slate-500 text-[11px]">${h.date}</td>
                    <td class="p-3 font-medium text-slate-700 truncate max-w-[200px]" title="${h.name}">${h.name}</td>
                    <td class="p-3">
                        <span class="px-2 py-1 rounded text-[10px] font-bold uppercase ${
                            h.category==='written'?'bg-blue-100 text-blue-700':
                            h.category==='performance'?'bg-emerald-100 text-emerald-700':
                            'bg-purple-100 text-purple-700'
                        }">
                            ${h.quarter.toUpperCase()}  ${h.category}
                        </span>
                    </td>
                    <td class="p-3 text-right font-mono text-slate-600">${h.score} / ${h.max}</td>
                    <td class="p-3 text-right text-xs text-slate-400">${h.weight}%</td>
                </tr>
            `).join('');
        }

        document.getElementById('inp-bonus').addEventListener('input', (e) => {
            if(currentStudentIdx === -1) return;
            let val = parseFloat(e.target.value) || 0;
            let s = students[currentStudentIdx];
            
            s.bonusPoints = val;
            s.grandTotal = s.calculatedGrandTotal + val;
            
            if(currentMode === 'college') {
                s.transmuted = transmute(s.grandTotal);
            } else {
                s.transmuted = s.grandTotal.toFixed(2);
            }
            
            updateReportVisuals(s);
            renderDashboard();
        });

        function updateReportVisuals(s) {
            const gradeEl = document.getElementById('rep-grade');
            gradeEl.innerText = s.transmuted;
            
            if(currentMode === 'college') {
                document.getElementById('rep-percent').innerText = s.grandTotal.toFixed(2) + "%";
                if(s.grandTotal < 50) {
                    gradeEl.className = "text-8xl font-black text-red-600 mb-1 tracking-tighter";
                } else {
                    gradeEl.className = "text-8xl font-black text-emerald-600 mb-1 tracking-tighter";
                }
            } else {
                if(s.grandTotal < 75) {
                    gradeEl.className = "text-8xl font-black text-red-600 mb-1 tracking-tighter";
                } else {
                    gradeEl.className = "text-8xl font-black text-emerald-600 mb-1 tracking-tighter";
                }
            }
            // update letter/remark if present
            const repL = document.getElementById('rep-letter');
            if(repL) {
                const g = gradeLetter(s.grandTotal);
                repL.innerText = `${g.letter}  ${g.remark}`;
            }
        }

        // Email student using mailto: with plain-text report
        function emailStudent() {
            if(currentStudentIdx === -1) return alert('No student selected');
            const s = students[currentStudentIdx];
            if(!s) return alert('Student not found');
            if(!s.email || s.email.trim() === '') return alert('No email found for this student');

            const to = s.email.trim();
            const subject = `${s.name} | ${courseInfo.subject || ''} | ${courseInfo.section || ''} | Grades Report`;

const lines = [];

lines.push("STUDENT GRADE REPORT");
lines.push("====================================");
lines.push(`Name: ${s.name}`);
lines.push(`Student ID: ${s.id}`);
lines.push(`Subject: ${courseInfo.subject || '--'}`);
lines.push(`Section: ${courseInfo.section || '--'}`);
lines.push(`School Year: ${courseInfo.schoolYear || '--'}`);
lines.push("");

if(currentMode === 'college') {
    lines.push("TERM PERFORMANCE SUMMARY");
    lines.push("------------------------------------");

    ['prelim','midterm','prefinal','final'].forEach(t => {
        const tt = s.terms[t];
        const termScale = convertTo1to5Scale(tt.final);
        lines.push(
          `${t.toUpperCase()}  LMS ${tt.lmsFinal.toFixed(1)}% | ` +
          `Lecture ${tt.lecFinal.toFixed(1)}% | ` +
          `Lab ${tt.labFinal.toFixed(1)}% | ` +
          `TERM ${tt.final.toFixed(1)}% | 1-5 Scale: ${termScale.toFixed(1)}`
        );
    });

    lines.push("");
    lines.push("OVERALL RESULT");
    lines.push("------------------------------------");
    lines.push(`Final Numeric Grade: ${s.grandTotal.toFixed(2)}%`);
    lines.push(`Equivalent Grade: ${s.transmuted}`);
    const gl = gradeLetter(s.grandTotal);
    lines.push(`Remarks: ${gl.letter} - ${gl.remark}`);
} else {
    lines.push("QUARTER PERFORMANCE SUMMARY");
    lines.push("------------------------------------");

    ['q3','q4'].forEach(q => {
        const qq = s.quarters[q];
        lines.push(
          `${q.toUpperCase()}  Written ${qq.writtenGrade.toFixed(1)}% | ` +
          `Performance ${qq.performanceGrade.toFixed(1)}% | ` +
          `Exam ${qq.assessmentGrade.toFixed(1)}% | ` +
          `GRADE ${qq.final.toFixed(1)}%`
        );
    });

    lines.push("");
    lines.push("OVERALL RESULT");
    lines.push("------------------------------------");
    lines.push(`Final Numeric Grade: ${s.grandTotal.toFixed(2)}%`);
    lines.push(`Equivalent Grade: ${s.transmuted}`);
    const gl2 = gradeLetter(s.grandTotal);
    lines.push(`Remarks: ${gl2.letter} - ${gl2.remark}`);
}

lines.push("");
lines.push("CLASS RECORD");
lines.push("------------------------------------");
lines.push(`Attendance: ${s.attendance}`);
if(s.bonusPoints && s.bonusPoints !== 0)
    lines.push(`Bonus Points: ${s.bonusPoints}`);

lines.push("");
lines.push("DETAILED ACTIVITY BREAKDOWN");
lines.push("------------------------------------");

s.history.forEach(h => {
    if(h) {
        lines.push(
          `${h.date || '-'} | ${h.name || '-'} | ${h.source || ''} ${h.cat || ''} ${h.type || ''} | ${h.score}/${h.max} (${h.weight}%)`
        );
    }
});

lines.push("");
lines.push("This is a system-generated academic report.");
lines.push("For questions regarding grading, please contact your instructor.");


            const body = lines.join('\n');
            const mailto = `mailto:${to}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
            window.open(mailto, '_blank');
        }
        

        function copyEmailHTML() {
            if (currentStudentIdx === -1) return alert('No student selected');
            const s = students[currentStudentIdx];
            if (!s) return alert('Student not found');

            let emailHTML = '';

            if(currentMode === 'college') {
                emailHTML = generateCollegeEmailHTML(s);
            } else {
                emailHTML = generateSHSEmailHTML(s);
            }

            navigator.clipboard.writeText(emailHTML).then(() => {
                alert('Email HTML copied to clipboard! Ready to paste in email or embed.');
            }).catch(err => {
                alert('Failed to copy email HTML: ' + err);
            });
        }

        function generateCollegeEmailHTML(s) {
            const gl = gradeLetter(s.grandTotal);
            const comment = document.getElementById('inp-comment').value || '';
            const attendance = document.getElementById('inp-att-present').value || s.attendance;
            const bonus = parseFloat(document.getElementById('inp-bonus').value) || s.bonusPoints || 0;

            return `
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Grade Report - ${s.name}</title>
</head>
<body style="margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;">

<div style="background: linear-gradient(135deg, #f9fafb 0%, #f3f4f6 100%); padding: 30px 20px; min-height: 100vh;">
    <div style="max-width: 700px; margin: 0 auto; background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 10px 40px rgba(0, 0, 0, 0.08);">
        
        <!-- Header -->
        <div style="background: linear-gradient(135deg, #1f2937 0%, #111827 100%); color: white; padding: 30px 20px; text-align: center;">
            <h1 style="margin: 0 0 5px 0; font-size: 28px; font-weight: 700;">Bemmygail Learning Hub</h1>
            <p style="margin: 0; font-size: 12px; opacity: 0.9; letter-spacing: 1px;">GRADING & REPORTING SYSTEM</p>
        </div>

        <!-- Course Info -->
        <div style="background: #f0f9ff; border-bottom: 2px solid #e0f2fe; padding: 20px; margin: 0;">
            <table style="width: 100%; font-size: 13px; color: #475569;">
                <tr>
                    <td style="padding: 8px 0;"><strong style="color: #1e40af;">Subject:</strong> ${courseInfo.subject || '--'}</td>
                    <td style="padding: 8px 0; text-align: right;"><strong style="color: #1e40af;">Section:</strong> ${courseInfo.section || '--'}</td>
                </tr>
                <tr>
                    <td style="padding: 8px 0;"><strong style="color: #1e40af;">School Year:</strong> ${courseInfo.schoolYear || '--'}</td>
                    <td style="padding: 8px 0; text-align: right;"><strong style="color: #1e40af;">Date:</strong> ${new Date().toLocaleDateString()}</td>
                </tr>
            </table>
        </div>

        <!-- Student Greeting -->
        <div style="padding: 30px 20px; border-bottom: 1px solid #e5e7eb;">
            <p style="margin: 0 0 15px 0; font-size: 16px; color: #1f2937;">
                <strong>Dear ${s.name},</strong>
            </p>
            <p style="margin: 0; font-size: 14px; color: #4b5563; line-height: 1.6;">
                Please find below your detailed grade report for ${courseInfo.subject || 'the course'}. This report includes your term performance, final grade, and a complete breakdown of all activities and assessments.
            </p>
        </div>

        <!-- Final Grade Summary Card -->
        <div style="padding: 25px 20px; background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%); border-bottom: 2px solid #3b82f6; text-align: center;">
            <p style="margin: 0 0 10px 0; font-size: 11px; color: #1e40af; font-weight: 700; letter-spacing: 1px; text-transform: uppercase;">Final Grade</p>
            <div style="font-size: 48px; font-weight: 900; color: ${s.grandTotal >= 50 ? '#059669' : '#dc2626'}; margin: 0 0 10px 0;">
                ${s.transmuted}
            </div>
            <p style="margin: 0 0 5px 0; font-size: 14px; color: #1f2937;">
                <strong>${gl.letter}</strong>  ${gl.remark}
            </p>
            <p style="margin: 0; font-size: 12px; color: #4b5563;">
                ${s.grandTotal.toFixed(2)}% Grade
            </p>
        </div>

        <!-- Term Summary Table -->
        <div style="padding: 25px 20px; border-bottom: 1px solid #e5e7eb;">
            <h3 style="margin: 0 0 15px 0; font-size: 15px; color: #1f2937; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px;">Term Performance Breakdown</h3>
            <table style="width: 100%; border-collapse: collapse; font-size: 13px;">
                <thead>
                    <tr style="background: #f3f4f6;">
                        <th style="padding: 10px 8px; text-align: left; color: #4b5563; font-weight: 600; border-bottom: 2px solid #e5e7eb;">Term</th>
                        <th style="padding: 10px 8px; text-align: center; color: #4b5563; font-weight: 600; border-bottom: 2px solid #e5e7eb;">LMS</th>
                        <th style="padding: 10px 8px; text-align: center; color: #4b5563; font-weight: 600; border-bottom: 2px solid #e5e7eb;">Lecture</th>
                        <th style="padding: 10px 8px; text-align: center; color: #4b5563; font-weight: 600; border-bottom: 2px solid #e5e7eb;">Lab</th>
                        <th style="padding: 10px 8px; text-align: center; color: #4b5563; font-weight: 600; border-bottom: 2px solid #e5e7eb;">Total</th>
                        <th style="padding: 10px 8px; text-align: center; color: #4b5563; font-weight: 600; border-bottom: 2px solid #e5e7eb;">1-5 Scale</th>
                    </tr>
                </thead>
                <tbody>
                    ${['prelim', 'midterm', 'prefinal', 'final'].map((term, idx) => {
                        const t = s.terms[term];
                        const colors = ['#dbeafe', '#d1fae5', '#fed7aa', '#e9d5ff'];
                        const termScale = convertTo1to5Scale(t.final);
                        return `
                    <tr style="background: ${colors[idx]}; border-bottom: 1px solid #e5e7eb;">
                        <td style="padding: 12px 8px; font-weight: 600; color: #1f2937; text-transform: capitalize;">${term}</td>
                        <td style="padding: 12px 8px; text-align: center; color: #4b5563;">${t.lmsFinal.toFixed(0)}%</td>
                        <td style="padding: 12px 8px; text-align: center; color: #4b5563;">${t.lecFinal.toFixed(0)}%</td>
                        <td style="padding: 12px 8px; text-align: center; color: #4b5563;">${t.labFinal.toFixed(0)}%</td>
                        <td style="padding: 12px 8px; text-align: center; font-weight: 700; color: #1f2937;">${t.final.toFixed(1)}%</td>
                        <td style="padding: 12px 8px; text-align: center; font-weight: 700; color: #1f2937;">${termScale.toFixed(2)}</td>
                    </tr>
                        `;
                    }).join('')}
                </tbody>
            </table>
        </div>

        <!-- Attendance & Bonus -->
        <div style="padding: 25px 20px; background: #f9fafb; border-bottom: 1px solid #e5e7eb;">
            <h3 style="margin: 0 0 15px 0; font-size: 15px; color: #1f2937; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px;">Attendance & Adjustments</h3>
            <table style="width: 100%; font-size: 13px;">
                <tr>
                    <td style="padding: 10px 0; color: #4b5563;"><strong>Attendance (Present):</strong></td>
                    <td style="padding: 10px 0; text-align: right; color: #1f2937; font-weight: 600;">${attendance} days</td>
                </tr>
                ${bonus > 0 ? `
                <tr style="background: #d1fae5;">
                    <td style="padding: 10px 8px; color: #047857;"><strong>Bonus Points:</strong></td>
                    <td style="padding: 10px 8px; text-align: right; color: #047857; font-weight: 700;">+ ${bonus.toFixed(2)} points</td>
                </tr>
                ` : ''}
            </table>
        </div>

        <!-- Detailed Activity Log -->
        <div style="padding: 25px 20px; border-bottom: 1px solid #e5e7eb;">
            <h3 style="margin: 0 0 15px 0; font-size: 15px; color: #1f2937; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px;">Detailed Activity Log</h3>
            <div style="overflow-x: auto; border: 1px solid #e5e7eb; border-radius: 6px;">
                <table style="width: 100%; font-size: 12px; border-collapse: collapse;">
                    <thead>
                        <tr style="background: #f3f4f6;">
                            <th style="padding: 10px 8px; text-align: left; color: #4b5563; font-weight: 600; border-right: 1px solid #e5e7eb;">Date</th>
                            <th style="padding: 10px 8px; text-align: left; color: #4b5563; font-weight: 600; border-right: 1px solid #e5e7eb;">Activity</th>
                            <th style="padding: 10px 8px; text-align: center; color: #4b5563; font-weight: 600; border-right: 1px solid #e5e7eb;">Category</th>
                            <th style="padding: 10px 8px; text-align: right; color: #4b5563; font-weight: 600; border-right: 1px solid #e5e7eb;">Score</th>
                            <th style="padding: 10px 8px; text-align: center; color: #4b5563; font-weight: 600;">Weight</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${s.history.map((h, idx) => `
                        <tr style="border-bottom: 1px solid #e5e7eb; background: ${idx % 2 === 0 ? 'white' : '#fafafa'};">
                            <td style="padding: 10px 8px; color: #4b5563;">${h.date || '-'}</td>
                            <td style="padding: 10px 8px; color: #1f2937; font-weight: 500; max-width: 150px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${h.name}">${h.name}</td>
                            <td style="padding: 10px 8px; text-align: center;">
                                <span style="background: ${h.source === 'lms' ? '#dbeafe' : '#d1fae5'}; color: ${h.source === 'lms' ? '#1e40af' : '#047857'}; padding: 3px 6px; border-radius: 3px; font-size: 11px; font-weight: 600;">
                                    ${h.source.toUpperCase()} ${h.cat || ''} ${h.type || ''}
                                </span>
                            </td>
                            <td style="padding: 10px 8px; text-align: right; color: #1f2937; font-weight: 600; font-family: monospace;">${h.score}/${h.max}</td>
                            <td style="padding: 10px 8px; text-align: center; color: #4b5563;">${h.weight}%</td>
                        </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Instructor Remarks -->
        ${comment ? `
        <div style="padding: 25px 20px; background: #fef3c7; border-left: 4px solid #f59e0b; border-bottom: 1px solid #e5e7eb;">
            <h3 style="margin: 0 0 12px 0; font-size: 14px; color: #92400e; font-weight: 700;">Instructor Remarks</h3>
            <p style="margin: 0; font-size: 13px; color: #78350f; line-height: 1.6; white-space: pre-wrap; word-wrap: break-word;">${comment}</p>
        </div>
        ` : ''}

        <!-- Footer -->
        <div style="padding: 25px 20px; background: #f3f4f6; text-align: center; border-top: 1px solid #e5e7eb;">
            <p style="margin: 0 0 15px 0; font-size: 13px; color: #4b5563; line-height: 1.6;">
                If you have any questions regarding your grades or this report, please contact your instructor or visit the learning hub.
            </p>
            <div style="padding: 15px 0; border-top: 1px solid #e5e7eb;">
                <p style="margin: 0; font-size: 12px; color: #4b5563;">
                    <strong>Bemmygail Learning Hub</strong><br>
                    Grading & Reporting System
                </p>
                <p style="margin: 10px 0 0 0; font-size: 11px; color: #9ca3af;">
                    This is an automatically generated academic report. <br>
                    Generated on ${new Date().toLocaleString()}
                </p>
            </div>
        </div>

    </div>
</div>

</body>
</html>
            `;
        }

        function generateSHSEmailHTML(s) {
            const gl = gradeLetter(s.grandTotal);
            const comment = document.getElementById('inp-comment').value || '';
            const attendance = document.getElementById('inp-att-present').value || s.attendance;
            const bonus = parseFloat(document.getElementById('inp-bonus').value) || s.bonusPoints || 0;

            return `
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Grade Report - ${s.name}</title>
</head>
<body style="margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;">

<div style="background: linear-gradient(135deg, #f9fafb 0%, #f3f4f6 100%); padding: 30px 20px; min-height: 100vh;">
    <div style="max-width: 700px; margin: 0 auto; background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 10px 40px rgba(0, 0, 0, 0.08);">
        
        <!-- Header -->
        <div style="background: linear-gradient(135deg, #1f2937 0%, #111827 100%); color: white; padding: 30px 20px; text-align: center;">
            <h1 style="margin: 0 0 5px 0; font-size: 28px; font-weight: 700;">Bemmygail Learning Hub</h1>
            <p style="margin: 0; font-size: 12px; opacity: 0.9; letter-spacing: 1px;">GRADING & REPORTING SYSTEM</p>
        </div>

        <!-- Course Info -->
        <div style="background: #ecfdf5; border-bottom: 2px solid #a7f3d0; padding: 20px; margin: 0;">
            <table style="width: 100%; font-size: 13px; color: #475569;">
                <tr>
                    <td style="padding: 8px 0;"><strong style="color: #059669;">Subject:</strong> ${courseInfo.subject || '--'}</td>
                    <td style="padding: 8px 0; text-align: right;"><strong style="color: #059669;">Section:</strong> ${courseInfo.section || '--'}</td>
                </tr>
                <tr>
                    <td style="padding: 8px 0;"><strong style="color: #059669;">School Year:</strong> ${courseInfo.schoolYear || '--'}</td>
                    <td style="padding: 8px 0; text-align: right;"><strong style="color: #059669;">Date:</strong> ${new Date().toLocaleDateString()}</td>
                </tr>
            </table>
        </div>

        <!-- Student Greeting -->
        <div style="padding: 30px 20px; border-bottom: 1px solid #e5e7eb;">
            <p style="margin: 0 0 15px 0; font-size: 16px; color: #1f2937;">
                <strong>Dear ${s.name},</strong>
            </p>
            <p style="margin: 0; font-size: 14px; color: #4b5563; line-height: 1.6;">
                Please find below your detailed grade report for ${courseInfo.subject || 'the course'}. This report includes your quarterly performance, final grade, and a complete breakdown of all assessments.
            </p>
        </div>

        <!-- Final Grade Summary Card -->
        <div style="padding: 25px 20px; background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%); border-bottom: 2px solid #10b981; text-align: center;">
            <p style="margin: 0 0 10px 0; font-size: 11px; color: #047857; font-weight: 700; letter-spacing: 1px; text-transform: uppercase;">Semestral Grade</p>
            <div style="font-size: 48px; font-weight: 900; color: ${s.grandTotal >= 75 ? '#059669' : '#dc2626'}; margin: 0 0 10px 0;">
                ${s.transmuted}
            </div>
            <p style="margin: 0 0 5px 0; font-size: 14px; color: #1f2937;">
                <strong>${gl.letter}</strong>  ${gl.remark}
            </p>
            <p style="margin: 0; font-size: 12px; color: #4b5563;">
                ${s.grandTotal.toFixed(2)}% Grade
            </p>
        </div>

        <!-- Quarter Summary Table -->
        <div style="padding: 25px 20px; border-bottom: 1px solid #e5e7eb;">
            <h3 style="margin: 0 0 15px 0; font-size: 15px; color: #1f2937; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px;">Quarter Performance Breakdown</h3>
            <table style="width: 100%; border-collapse: collapse; font-size: 13px;">
                <thead>
                    <tr style="background: #f3f4f6;">
                        <th style="padding: 10px 8px; text-align: left; color: #4b5563; font-weight: 600; border-bottom: 2px solid #e5e7eb;">Quarter</th>
                        <th style="padding: 10px 8px; text-align: center; color: #4b5563; font-weight: 600; border-bottom: 2px solid #e5e7eb;" title="Written Work">Written</th>
                        <th style="padding: 10px 8px; text-align: center; color: #4b5563; font-weight: 600; border-bottom: 2px solid #e5e7eb;" title="Performance Task">Performance</th>
                        <th style="padding: 10px 8px; text-align: center; color: #4b5563; font-weight: 600; border-bottom: 2px solid #e5e7eb;" title="Quarterly Assessment">Assessment</th>
                        <th style="padding: 10px 8px; text-align: center; color: #4b5563; font-weight: 600; border-bottom: 2px solid #e5e7eb;">Grade</th>
                    </tr>
                </thead>
                <tbody>
                    ${['q3', 'q4'].map((q, idx) => {
                        const qq = s.quarters[q];
                        const colors = ['#dbeafe', '#d1fae5'];
                        return `
                    <tr style="background: ${colors[idx]}; border-bottom: 1px solid #e5e7eb;">
                        <td style="padding: 12px 8px; font-weight: 600; color: #1f2937;">${q === 'q3' ? 'Quarter 3' : 'Quarter 4'}</td>
                        <td style="padding: 12px 8px; text-align: center; color: #4b5563;">${qq.writtenGrade.toFixed(0)}%</td>
                        <td style="padding: 12px 8px; text-align: center; color: #4b5563;">${qq.performanceGrade.toFixed(0)}%</td>
                        <td style="padding: 12px 8px; text-align: center; color: #4b5563;">${qq.assessmentGrade.toFixed(0)}%</td>
                        <td style="padding: 12px 8px; text-align: center; font-weight: 700; color: #1f2937;">${qq.final.toFixed(1)}%</td>
                    </tr>
                        `;
                    }).join('')}
                </tbody>
            </table>
        </div>

        <!-- Attendance & Bonus -->
        <div style="padding: 25px 20px; background: #f9fafb; border-bottom: 1px solid #e5e7eb;">
            <h3 style="margin: 0 0 15px 0; font-size: 15px; color: #1f2937; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px;">Attendance & Adjustments</h3>
            <table style="width: 100%; font-size: 13px;">
                <tr>
                    <td style="padding: 10px 0; color: #4b5563;"><strong>Attendance (Present):</strong></td>
                    <td style="padding: 10px 0; text-align: right; color: #1f2937; font-weight: 600;">${attendance} days</td>
                </tr>
                ${bonus > 0 ? `
                <tr style="background: #d1fae5;">
                    <td style="padding: 10px 8px; color: #047857;"><strong>Bonus Points:</strong></td>
                    <td style="padding: 10px 8px; text-align: right; color: #047857; font-weight: 700;">+ ${bonus.toFixed(2)} points</td>
                </tr>
                ` : ''}
            </table>
        </div>

        <!-- Detailed Activity Log -->
        <div style="padding: 25px 20px; border-bottom: 1px solid #e5e7eb;">
            <h3 style="margin: 0 0 15px 0; font-size: 15px; color: #1f2937; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px;">Detailed Activity Log</h3>
            <div style="overflow-x: auto; border: 1px solid #e5e7eb; border-radius: 6px;">
                <table style="width: 100%; font-size: 12px; border-collapse: collapse;">
                    <thead>
                        <tr style="background: #f3f4f6;">
                            <th style="padding: 10px 8px; text-align: left; color: #4b5563; font-weight: 600; border-right: 1px solid #e5e7eb;">Date</th>
                            <th style="padding: 10px 8px; text-align: left; color: #4b5563; font-weight: 600; border-right: 1px solid #e5e7eb;">Activity</th>
                            <th style="padding: 10px 8px; text-align: center; color: #4b5563; font-weight: 600; border-right: 1px solid #e5e7eb;">Category</th>
                            <th style="padding: 10px 8px; text-align: right; color: #4b5563; font-weight: 600; border-right: 1px solid #e5e7eb;">Score</th>
                            <th style="padding: 10px 8px; text-align: center; color: #4b5563; font-weight: 600;">Weight</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${s.history.map((h, idx) => {
                            const catColor = h.category === 'written' ? '#dbeafe' : 
                                           h.category === 'performance' ? '#d1fae5' : '#e9d5ff';
                            const catColorText = h.category === 'written' ? '#1e40af' : 
                                               h.category === 'performance' ? '#047857' : '#6b21a8';
                            return `
                        <tr style="border-bottom: 1px solid #e5e7eb; background: ${idx % 2 === 0 ? 'white' : '#fafafa'};">
                            <td style="padding: 10px 8px; color: #4b5563;">${h.date || '-'}</td>
                            <td style="padding: 10px 8px; color: #1f2937; font-weight: 500; max-width: 150px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${h.name}">${h.name}</td>
                            <td style="padding: 10px 8px; text-align: center;">
                                <span style="background: ${catColor}; color: ${catColorText}; padding: 3px 6px; border-radius: 3px; font-size: 11px; font-weight: 600; text-transform: capitalize;">
                                    ${h.category}
                                </span>
                            </td>
                            <td style="padding: 10px 8px; text-align: right; color: #1f2937; font-weight: 600; font-family: monospace;">${h.score}/${h.max}</td>
                            <td style="padding: 10px 8px; text-align: center; color: #4b5563;">${h.weight}%</td>
                        </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Instructor Remarks -->
        ${comment ? `
        <div style="padding: 25px 20px; background: #fef3c7; border-left: 4px solid #f59e0b; border-bottom: 1px solid #e5e7eb;">
            <h3 style="margin: 0 0 12px 0; font-size: 14px; color: #92400e; font-weight: 700;">Instructor Remarks</h3>
            <p style="margin: 0; font-size: 13px; color: #78350f; line-height: 1.6; white-space: pre-wrap; word-wrap: break-word;">${comment}</p>
        </div>
        ` : ''}

        <!-- Footer -->
        <div style="padding: 25px 20px; background: #f3f4f6; text-align: center; border-top: 1px solid #e5e7eb;">
            <p style="margin: 0 0 15px 0; font-size: 13px; color: #4b5563; line-height: 1.6;">
                If you have any questions regarding your grades or this report, please contact your instructor or visit the learning hub.
            </p>
            <div style="padding: 15px 0; border-top: 1px solid #e5e7eb;">
                <p style="margin: 0; font-size: 12px; color: #4b5563;">
                    <strong>Bemmygail Learning Hub</strong><br>
                    Grading & Reporting System
                </p>
                <p style="margin: 10px 0 0 0; font-size: 11px; color: #9ca3af;">
                    This is an automatically generated academic report. <br>
                    Generated on ${new Date().toLocaleString()}
                </p>
            </div>
        </div>

    </div>
</div>

</body>
</html>
            `;
        }

        // Search
        document.getElementById('searchInput').addEventListener('keyup', (e) => {
            const val = e.target.value.toLowerCase();
            document.querySelectorAll('#masterBody tr').forEach(row => {
                row.style.display = row.innerText.toLowerCase().includes(val) ? '' : 'none';
            });
        });

        // Sorting
        let sortState = { key: null, asc: true };
        function sortTable(type) {
            if(!students || students.length === 0) return;

            if(sortState.key === type) {
                sortState.asc = !sortState.asc; // toggle
            } else {
                sortState.key = type;
                // default: name ascending, grade descending
                sortState.asc = type === 'name' ? true : false;
            }

            students.sort((a,b) => {
                if(type === 'name') {
                    const A = a.name.toLowerCase();
                    const B = b.name.toLowerCase();
                    if(A < B) return sortState.asc ? -1 : 1;
                    if(A > B) return sortState.asc ? 1 : -1;
                    return 0;
                } else if(type === 'grade') {
                    const A = parseFloat(a.grandTotal) || 0;
                    const B = parseFloat(b.grandTotal) || 0;
                    return sortState.asc ? A - B : B - A;
                }
                return 0;
            });

            renderDashboard();

            // Optionally, scroll to top of table for visibility
            const tableWrap = document.querySelector('.table-container');
            if(tableWrap) tableWrap.scrollTop = 0;
        }

        // Export master table to Excel
        function exportExcel() {
            if(!students || students.length === 0) return alert('No data to export');

            const rows = students.map(s => {
                if(currentMode === 'college') {
                    return {
                        Name: s.name,
                        ID: s.id,
                        Prelim: s.terms.prelim.final.toFixed(1),
                        Midterm: s.terms.midterm.final.toFixed(1),
                        PreFinal: s.terms.prefinal.final.toFixed(1),
                        Finals: s.terms.final.final.toFixed(1),
                        Percentage: s.grandTotal.toFixed(2),
                        Transmuted: s.transmuted,
                        Letter: gradeLetter(s.grandTotal).letter,
                        Remark: gradeLetter(s.grandTotal).remark
                    };
                } else {
                    return {
                        Name: s.name,
                        ID: s.id,
                        Q3: s.quarters.q3.final.toFixed(1),
                        Q4: s.quarters.q4.final.toFixed(1),
                        Percentage: s.grandTotal.toFixed(2),
                        Transmuted: s.transmuted,
                        Letter: gradeLetter(s.grandTotal).letter,
                        Remark: gradeLetter(s.grandTotal).remark
                    };
                }
            });

            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.json_to_sheet(rows);
            XLSX.utils.book_append_sheet(wb, ws, 'Grades');
            const wbout = XLSX.write(wb, { bookType: 'xlsx', type: 'array' });
            const blob = new Blob([wbout], { type: 'application/octet-stream' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${currentMode || 'grades'}_master.xlsx`;
            document.body.appendChild(a);
            a.click();
            a.remove();
            URL.revokeObjectURL(url);
        }

        // Print master table as-is (open new window with table & signatures)
        function printMaster() {
            const table = document.getElementById('masterTable');
            if(!table) return alert('No table to print');

            const win = window.open('', '_blank', 'width=1400,height=900');
            if(!win) return alert('Pop-up blocked. Allow popups to print.');

            // Get table with headers
            const tableHtml = table.outerHTML;
            
            // Get signature block
            const sigBlock = document.querySelector('#step-dashboard .rounded-b-xl');
            const sigHtml = sigBlock ? sigBlock.outerHTML : '';

            // Build course info header
            const courseHtml = `
                <div style="margin-bottom: 25px; padding: 15px; background: #f0f9ff; border: 1px solid #e0f2fe; border-radius: 8px;">
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; text-align: center;">
                        <div>
                            <div style="font-size: 11px; color: #666; font-weight: bold; text-transform: uppercase; margin-bottom: 5px;">Subject</div>
                            <div style="font-size: 14px; font-weight: bold;">${courseInfo.subject || '--'}</div>
                        </div>
                        <div>
                            <div style="font-size: 11px; color: #666; font-weight: bold; text-transform: uppercase; margin-bottom: 5px;">Section</div>
                            <div style="font-size: 14px; font-weight: bold;">${courseInfo.section || '--'}</div>
                        </div>
                        <div>
                            <div style="font-size: 11px; color: #666; font-weight: bold; text-transform: uppercase; margin-bottom: 5px;">School Year</div>
                            <div style="font-size: 14px; font-weight: bold;">${courseInfo.schoolYear || '--'}</div>
                        </div>
                    </div>
                </div>
            `;

            const styles = `
                <style>
                    body { font-family: 'Inter', Arial, sans-serif; margin: 20px; background: white; }
                    table { border-collapse: collapse; width: 100%; margin-bottom: 30px; }
                    th, td { border: 1px solid #ccc; padding: 8px; text-align: center; font-size: 12px; }
                    th { background: #f3f4f6; font-weight: bold; }
                    tr:nth-child(even) { background: #fafafa; }
                    .sticky-left-1, .sticky-left-2 { text-align: left; }
                    .rounded-b-xl { margin-top: 30px; padding: 30px 0; border-top: 2px solid #333; }
                    .rounded-b-xl > div { display: flex; justify-content: space-between; }
                    .rounded-b-xl > div > div { width: 30%; text-align: center; }
                    .border-t-2 { border-top: 2px solid #333; padding-top: 15px; margin-bottom: 5px; font-weight: bold; font-size: 11px; }
                    @media print { body { margin: 10px; } }
                </style>
            `;

            win.document.open();
            win.document.write('<!DOCTYPE html><html><head><meta charset="UTF-8">' + styles + '</head><body>');
            win.document.write(courseHtml);
            win.document.write(tableHtml);
            win.document.write(sigHtml);
            win.document.write('</body></html>');
            win.document.close();
            setTimeout(() => { win.focus(); win.print(); }, 600);
        }
    </script>
</body>
</html>
